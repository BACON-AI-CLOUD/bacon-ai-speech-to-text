# ADD-004: BACON-AI Voice v1.4 - File Transcription & Suffix Injections Architecture

| Field | Value |
|-------|-------|
| **Document ID** | ADD-004 |
| **Version** | 1.4 |
| **Status** | Draft |
| **Date** | 2026-02-23 |
| **Parent** | ADD-001 (v1.0), ADD-002 (v1.1) |

---

## 1. Overview

v1.4 adds two features to BACON-AI Voice:

1. **File Transcription Panel** (FEAT-310): Upload or reference local audio/video files for transcription using the already-loaded Whisper model, with optional refiner pass and downloadable output in .txt, .srt, or .vtt format.
2. **Suffix Injection Prompts** (FEAT-311): Configurable text snippets automatically appended to transcriptions before they reach the refiner or keyboard output. Includes 10 built-in prompts and user-defined custom injections.

### Design Goals

1. **Model reuse**: File transcription uses the same Whisper model instance already loaded for live STT -- no duplicate memory allocation
2. **Pipeline reuse**: File transcriptions can optionally pass through the existing refiner pipeline (same providers, same prompt, same config)
3. **Non-blocking**: File transcription runs in the backend; the UI remains responsive for live transcription
4. **Injection transparency**: Suffix injections are visible to the user and consistently applied across all output paths
5. **Cleanup**: Temporary output files are auto-deleted after 10 minutes

---

## 2. Backend Architecture (v1.4 Delta)

### 2.1 New Router: `file_transcribe.py`

**Location:** `src/backend/app/file_transcribe.py`

#### Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/transcribe/file/upload` | Upload audio/video file via multipart form |
| POST | `/transcribe/file/path` | Transcribe a local file by absolute path |
| GET | `/transcribe/file/output/{filename}` | Download generated output file |

#### Request Model: `FileTranscribeOptions`

```python
class FileTranscribeOptions(BaseModel):
    language: str = "auto"           # ISO 639-1 code or "auto"
    output_format: str = "txt"       # "txt", "srt", "vtt"
    refine: bool = False             # Pipe through refiner
    refine_provider: str | None = None  # Override current provider (optional)
    custom_prompt: str | None = None    # Override refiner prompt (optional)
```

#### Response Model: `FileTranscribeResult`

```python
class FileTranscribeResult(BaseModel):
    text: str                        # Full transcription text
    refined_text: str | None = None  # Refined text (if refine=True)
    language: str                    # Detected or specified language
    duration: float                  # Audio duration in seconds
    output_url: str                  # URL to download output file
    output_format: str               # Format of output file
    processing_time_ms: int          # Total processing time
    segments: list[dict] | None = None  # Whisper segments (for SRT/VTT)
```

#### Output Directory

- Path: `/tmp/bacon-voice-transcripts/`
- Auto-created on first use
- Cleanup: Background task deletes files older than 10 minutes
- Filenames: `{uuid}.{format}` (e.g., `a1b2c3d4.srt`)

#### Processing Flow

```
File Upload/Path
      │
      ▼
  Validate file exists & format supported
      │
      ▼
  Whisper transcribe (reuse loaded model)
      │
      ├── Generate segments with timestamps
      │
      ▼
  Format output (.txt / .srt / .vtt)
      │
      ▼
  Save to /tmp/bacon-voice-transcripts/
      │
      ├── If refine=True:
      │     └── Send text through refiner pipeline
      │           └── Return both raw + refined
      │
      ▼
  Return FileTranscribeResult
```

### 2.2 New Endpoints in `main.py`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/windows/active` | Return list of visible window titles (for keyboard target picker) |
| POST | `/keyboard/set-target` | Set runtime target window title |
| GET | `/keyboard/target` | Get current target window title |

#### Target Window Logic

The existing `POST /keyboard/type` endpoint is modified to check `_runtime_target_window` as a fallback when the request does not include an explicit window title:

```python
# In main.py
_runtime_target_window: str | None = None

@app.post("/keyboard/set-target")
async def set_keyboard_target(body: dict):
    global _runtime_target_window
    _runtime_target_window = body.get("window_title")
    return {"target": _runtime_target_window}

@app.get("/keyboard/target")
async def get_keyboard_target():
    return {"target": _runtime_target_window}

@app.get("/windows/active")
async def get_active_windows():
    # Uses wmctrl or xdotool on Linux, pygetwindow on Windows
    ...
```

### 2.3 SRT / VTT Format Generation

```python
def format_srt(segments: list[dict]) -> str:
    """Generate SubRip subtitle format from Whisper segments."""
    lines = []
    for i, seg in enumerate(segments, 1):
        start = format_timestamp_srt(seg["start"])
        end = format_timestamp_srt(seg["end"])
        lines.append(f"{i}")
        lines.append(f"{start} --> {end}")
        lines.append(seg["text"].strip())
        lines.append("")
    return "\n".join(lines)

def format_vtt(segments: list[dict]) -> str:
    """Generate WebVTT subtitle format from Whisper segments."""
    lines = ["WEBVTT", ""]
    for seg in segments:
        start = format_timestamp_vtt(seg["start"])
        end = format_timestamp_vtt(seg["end"])
        lines.append(f"{start} --> {end}")
        lines.append(seg["text"].strip())
        lines.append("")
    return "\n".join(lines)
```

---

## 3. Frontend Architecture (v1.4 Delta)

### 3.1 New Component: `FileTranscriptionPanel`

**Location:** `src/frontend/src/components/FileTranscriptionPanel.tsx`

Renders as a new tab alongside "Live" and "Discuss" in the main content area.

#### Features
- Drag-and-drop zone + file browse button
- Local path text input with "Go" button
- Language selector dropdown (auto-detect default)
- Output format selector (.txt, .srt, .vtt)
- Model selector (shows current model, allows override)
- "Pipe through refiner" checkbox
- Progress indicator during transcription
- Output text display area
- Download button + copy to clipboard

#### API Calls
- `POST /transcribe/file/upload` -- FormData with file + options
- `POST /transcribe/file/path` -- JSON with path + options
- Download via `GET /transcribe/file/output/{filename}`

### 3.2 Suffix Injection Types

**Location:** `src/frontend/src/types/index.ts` (extend existing)

```typescript
interface SuffixInjection {
  id: string;          // Unique ID (uuid for custom, slug for built-in e.g. "bacon-docs")
  label: string;       // Display label in UI
  text: string;        // Actual text to append
  enabled: boolean;    // Whether this injection is active
  builtIn: boolean;    // true = shipped with app, false = user-created
}
```

### 3.3 New AppSettings Fields

**Location:** `src/frontend/src/types/index.ts` (added to `AppSettings` interface)

```typescript
// Added to AppSettings interface
suffixInjections: SuffixInjection[];  // All injections (built-in + custom)
injectOnLive: boolean;                // Apply injections to live transcription
injectOnFile: boolean;                // Apply injections to file transcription
injectOnKeyboard: boolean;            // Apply injections to keyboard typing
```

Default values:
- `suffixInjections`: 10 built-in entries, all `enabled: false` by default
- `injectOnLive`: `false` (opt-in to avoid surprising live output)
- `injectOnFile`: `true` (enabled by default for file transcription)
- `injectOnKeyboard`: `false` (opt-in to avoid polluting keyboard output)

### 3.4 Utility: `buildTextWithInjections`

**Location:** `src/frontend/src/utils/buildTextWithInjections.ts`

**Important:** Uses `import type` for the `SuffixInjection` interface. Using a value import (`import { SuffixInjection }`) causes Vite/esbuild HMR to silently fail (blank page) because esbuild tries to track the runtime export which doesn't exist after TypeScript erasure.

```typescript
// CORRECT: type-only import to avoid HMR breakage
import type { SuffixInjection } from '../types';

export function buildTextWithInjections(text: string, injections: SuffixInjection[]): string {
  const active = injections.filter(i => i.enabled);
  if (active.length === 0) return text;
  return `${text}\n\n---\n\n${active.map(i => i.text).join('\n\n')}`;
}
```

Context gating (live/file/keyboard) is handled by each call site before invoking this utility — keeping the function pure and testable.

### 3.5 Integration Points: Where Injections Are Applied

| Location | Context | When Applied |
|----------|---------|--------------|
| `App.tsx` after live transcription result | `live` | Before sending to refiner or displaying |
| `FileTranscriptionPanel.tsx` after file result | `file` | Before displaying refined text |
| `App.tsx` keyboard type handler | `keyboard` | Before POST to `/keyboard/type` |

### 3.5b Supported File Formats

The file transcription panel accepts the following audio/video formats:

| Format | Extension | Notes |
|--------|-----------|-------|
| MP3 | `.mp3` | Most common audio format |
| WAV | `.wav` | Uncompressed audio |
| MP4 | `.mp4` | Video with audio track (requires ffmpeg) |
| MKV | `.mkv` | Matroska video (requires ffmpeg) |
| AVI | `.avi` | Legacy video (requires ffmpeg) |
| MOV | `.mov` | QuickTime (requires ffmpeg) |
| M4A | `.m4a` | Apple audio |
| AAC | `.aac` | Advanced Audio Codec |
| FLAC | `.flac` | Lossless audio |
| OGG | `.ogg` | Open format audio |
| WebM | `.webm` | Web video format |
| WMA | `.wma` | Windows Media Audio |

ffmpeg must be on `PATH` for video format decode. Already required by existing audio pipeline.

The frontend displays all supported formats in:
1. The `accept` attribute of the hidden file input
2. The drag-drop zone hint text (e.g. `mp3 · wav · mp4 · mkv · avi · mov · m4a · aac · flac · ogg · webm · wma`)
3. The local path input placeholder text

### 3.6 Built-in Injection Prompts (10)

| ID | Label | Purpose |
|----|-------|---------|
| `bacon-docs` | BACON docs reminder | Reminds to create PRDs, ADDs, test scripts per BACON directives |
| `action-items` | Extract action items | Extracts action items with owners and suggested due dates |
| `bullet-summary` | 3-bullet summary | Summarises in exactly 3 bullet points for executive briefing |
| `open-questions` | Open questions & blockers | Lists all open questions and blockers identified |
| `linear-issue` | Linear issue format | Formats as a Linear issue with concise title + detailed description |
| `key-decisions` | Key decisions + rationale | Extracts key decisions with rationale |
| `follow-up-email` | Follow-up email draft | Drafts a professional follow-up email |
| `tech-stack` | Tech & tools mentioned | Lists all technologies, tools, APIs and systems mentioned |
| `git-commit` | Git commit message | Writes conventional commit format message(s) for changes discussed |
| `security-check` | Security & privacy check | Identifies security, privacy, or compliance concerns |

All 10 are `enabled: false` and `builtIn: true` by default. Users can enable them individually; built-in prompts cannot be deleted.

---

## 4. Component Tree (v1.4 Delta)

```
App.tsx
├── HistorySidebar (existing v1.2)
├── Main Content Area
│   ├── Tab Bar: [ Live | File Transcription | Discuss ]
│   ├── Live Tab (existing)
│   │   ├── AudioCapture
│   │   ├── ActivationController
│   │   ├── WaveformVisualizer
│   │   ├── TranscriptionDisplay      <-- injects suffix before display
│   │   └── TextComparison
│   ├── File Transcription Tab (NEW)
│   │   └── FileTranscriptionPanel     <-- NEW component
│   └── Discuss Tab (existing v1.2)
│       └── DiscussPanel
├── Quick Controls Sidebar (right)
│   ├── Provider Tab (existing)
│   ├── Output Tab (existing)
│   └── Inject Tab (NEW)              <-- Suffix injection toggles
│       ├── Built-in injection checkboxes (10)
│       ├── Custom injection list
│       ├── Add custom injection button
│       └── "Apply to" checkboxes (live/file/keyboard)
└── StatusBar (existing)
```

---

## 5. System Architecture Diagram (v1.4)

```
┌─────────────────────────────────────────────────────────────────────┐
│                     BROWSER (React + Vite + TS)                      │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐│
│  │  Existing Components (v1.0-v1.2)                                  ││
│  │  AudioCapture, ActivationController, WaveformVisualizer,          ││
│  │  StatusBar, ErrorDisplay, ModelProgress, SettingsPanel,           ││
│  │  RefinerSettings, TextComparison, HistorySidebar, DiscussPanel   ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ┌──────────────────────┐  ┌────────────────────────────────────────┐│
│  │ FileTranscriptionPanel│  │ QCS Inject Tab (suffix injections)     ││
│  │ (NEW v1.4)            │  │ (NEW v1.4)                             ││
│  │ - Drag-drop upload    │  │ - 10 built-in toggles                  ││
│  │ - Local path input    │  │ - Custom injection CRUD                ││
│  │ - Format selector     │  │ - Apply-to context checkboxes          ││
│  │ - Progress indicator  │  │                                        ││
│  │ - Download/copy       │  │                                        ││
│  └──────────┬───────────┘  └────────────────────────────────────────┘│
│             │                                                         │
│       POST /transcribe/file/upload                                    │
│       POST /transcribe/file/path                                      │
│       GET  /transcribe/file/output/{filename}                         │
└─────────────┼─────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    BACKEND (Python + FastAPI)                         │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐│
│  │ Existing (v1.0-v1.2): Whisper Engine, Integration Router,        ││
│  │ Audio Converter, WebSocket Handler, Keyboard Emulator,           ││
│  │ Refiner Pipeline, 6 Providers, Discuss Mode, Config Manager     ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐│
│  │              File Transcribe Module (NEW v1.4)                    ││
│  │                                                                    ││
│  │  ┌───────────────────┐  ┌──────────────────────────────────┐     ││
│  │  │ file_transcribe.py│  │ Output Formatters                 │     ││
│  │  │ (FastAPI router)  │  │ - format_srt(segments)            │     ││
│  │  │                   │  │ - format_vtt(segments)            │     ││
│  │  │ POST /upload      │  │ - format_txt(text)               │     ││
│  │  │ POST /path        │  │                                   │     ││
│  │  │ GET  /output/     │  └──────────────────────────────────┘     ││
│  │  └───────┬───────────┘                                            ││
│  │          │  reuses                                                 ││
│  │          ▼                                                         ││
│  │  ┌──────────────────┐  ┌──────────────────────────────┐          ││
│  │  │ Whisper Engine   │  │ Refiner Pipeline              │          ││
│  │  │ (existing, shared│  │ (existing, optional pass)     │          ││
│  │  │  model instance) │  │                               │          ││
│  │  └──────────────────┘  └──────────────────────────────┘          ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐│
│  │  New main.py Endpoints (v1.4)                                     ││
│  │  GET  /windows/active        - List visible window titles        ││
│  │  POST /keyboard/set-target   - Set runtime target window          ││
│  │  GET  /keyboard/target       - Get current target window          ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  /tmp/bacon-voice-transcripts/   (output files, 10-min TTL)          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. Data Flow: File Transcription with Refiner + Injections

```
User uploads file
      │
      ▼
Frontend: FileTranscriptionPanel
      │  POST /transcribe/file/upload
      │  body: FormData { file, language, output_format, refine }
      ▼
Backend: file_transcribe.py
      │
      ├── 1. Save uploaded file to temp location
      ├── 2. Whisper transcribe (reuse loaded model)
      │       └── Returns: text + segments[]
      ├── 3. Format output (txt/srt/vtt)
      ├── 4. Save to /tmp/bacon-voice-transcripts/{uuid}.{fmt}
      ├── 5. If refine=True:
      │       └── refiner.process(text) → refined_text
      └── 6. Return FileTranscribeResult
              │
              ▼
Frontend: receives result
      │
      ├── 1. Display text (and refined_text if available)
      ├── 2. Apply suffix injections (buildTextWithInjections)
      └── 3. Show download link → GET /transcribe/file/output/{filename}
```

---

## 7. Security Considerations

- File uploads are stored temporarily and deleted after 10 minutes
- Local path endpoint only accessible from localhost (same CORS policy)
- No file path traversal: validate paths are absolute and exist
- Upload size limit enforced at 500 MB
- Output directory is `/tmp/` -- no persistent storage of user audio
