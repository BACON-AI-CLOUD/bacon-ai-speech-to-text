# PRD-003: BACON-AI Voice v1.3 - UX Enhancements & New Modes

**Version:** 1.3
**Status:** Draft
**Author:** Orchestrator Agent (Opus 4.6)
**Date:** 2026-02-19
**Owner:** Colin Bacon
**Depends On:** PRD-001 (v1.0 Core STT), PRD-002 (v1.1 Text Refinement)

---

## 1. Problem Statement

### 1.1 Current State
BACON-AI Voice v1.1 delivers STT with AI text refinement, multiple providers, and a discuss mode. However daily usage reveals several UX friction points:
- **Settings buried in modal**: Switching providers, models, and prompt templates requires opening the settings gear, scrolling to the refiner section. Power users need instant access.
- **Output controls hidden**: Target window and send-to checkboxes are inside settings. Changing where text goes should be one click away.
- **No persistent history**: Transcription history is lost on page refresh. No way to organize by project.
- **Single-shot interaction**: Each transcription is independent. No way to have an ongoing conversation with the AI or dictate long-form content across pauses.
- **No MCP integration for refinement**: The text refinement engine can't be used by other Claude Code sessions or tools.
- **No wake word**: Must manually click/press to activate. Voice-first interaction requires hands-free triggering.
- **Audio feedback limited**: The 3-beep status sounds only work with REST API connection, not all trigger modes.

### 1.2 Desired State
A polished, power-user-optimized voice interface with:
- Quick-access controls always visible on the right margin
- A full chatbot interface for conversational AI via voice or text
- Long-form dictation with pause/resume and canvas sessions
- Persistent, project-organized history
- MCP server for cross-tool text refinement
- Wake word activation for hands-free operation
- Consistent audio feedback across all modes

### 1.3 Success Criteria
- SC-301: Provider/model/template switch takes < 2 clicks from any view
- SC-302: Chat interface supports voice input, text input, and paste
- SC-303: Dictation mode auto-pauses on silence, resumes on speech, accumulates in one canvas
- SC-304: History persists across browser sessions and can be grouped by project
- SC-305: MCP server exposes text refinement with current config as defaults
- SC-306: Wake word triggers STT without any click/keypress
- SC-307: Audio beeps work with all activation modes (push-to-talk, VAD, toggle, wake word)
- SC-308: Mini-button mode collapses browser to minimal footprint

---

## 2. Scope

### 2.1 In Scope

| ID | Requirement | Priority | Category |
|----|------------|----------|----------|
| REQ-301 | Right sidebar: collapsible quick-access panel for provider, model, and prompt template switching | P0 (Must) | UX |
| REQ-302 | Right sidebar: output controls tab (send-to checkboxes, target window selector) | P0 (Must) | UX |
| REQ-303 | Audio beeps (3-tone status sounds) for all activation/trigger modes | P1 (Should) | UX |
| REQ-304 | Chat tab: chatbot-style UI connected to text refinement engine | P0 (Must) | New Mode |
| REQ-305 | Chat tab: microphone icon for voice input to chat | P0 (Must) | New Mode |
| REQ-306 | Chat tab: text input area for typing/pasting into chat prompt | P0 (Must) | New Mode |
| REQ-307 | Dictation mode: continuous voice with auto-pause on silence | P0 (Must) | New Mode |
| REQ-308 | Dictation mode: parallel transcription (writes previous while listening) | P1 (Should) | New Mode |
| REQ-309 | Dictation mode: canvas sessions (accumulate text, "New Chat" clears canvas) | P0 (Must) | New Mode |
| REQ-310 | Dictation mode: saves completed session to history on "New Chat" | P0 (Must) | New Mode |
| REQ-311 | MCP server: text refinement tool using current config defaults | P1 (Should) | Integration |
| REQ-312 | MCP server: accepts optional provider, model, template overrides | P1 (Should) | Integration |
| REQ-313 | Wake word trigger: configurable keyword (default "Hey Colin") | P2 (Could) | New Mode |
| REQ-314 | Wake word: always-listening with low CPU, triggers STT on detection | P2 (Could) | New Mode |
| REQ-315 | Mini-button collapse: browser resizes to small floating widget | P1 (Should) | UX |
| REQ-316 | Mini-button collapse: removes header bars, minimal footprint | P1 (Should) | UX |
| REQ-317 | History: scrollable left sidebar with overflow handling | P0 (Must) | UX |
| REQ-318 | History: persistent storage (file or database), survives session restart | P0 (Must) | Data |
| REQ-319 | History: project grouping (create projects, assign transcriptions) | P1 (Should) | Data |
| REQ-320 | History: project-based filtering like Claude Code conversation groups | P1 (Should) | UX |

### 2.2 Out of Scope (Deferred)
| Item | Reason | Target |
|------|--------|--------|
| Multi-language STT | Separate concern, English-only for now | v1.4 |
| TTS read-back of responses | Can layer on top of chat tab later | v1.4 |
| Real-time streaming transcription | Requires WebSocket streaming, complex | v2.0 |
| Mobile/responsive layout | Desktop-first for now | v2.0 |

---

## 3. Feature Details

### 3.1 Right Sidebar Quick Controls (REQ-301, REQ-302)

**Problem:** Switching provider, model, or template requires: click gear -> scroll to refiner -> change dropdown -> close settings. Too many steps for frequent use.

**Solution:** A collapsible right-margin panel with two tabs:

**Tab 1: Refinement Controls**
- Provider dropdown (Groq, Ollama, OpenAI, Anthropic, Gemini, Claude CLI)
- Model dropdown (filtered to selected provider)
- Prompt template dropdown (Email, Notes, Code, etc.)
- Enable/disable refinement toggle

**Tab 2: Output Controls**
- Send-to checkboxes (Clipboard, Target Window, Claude API, WebSocket Bridge, MCP)
- Target window selector (dropdown or text input)
- Quick-switch between common targets

**Behavior:**
- Panel slides in from right edge, overlays content (doesn't push layout)
- Collapses to a thin tab/icon strip when closed
- State persists via localStorage
- Keyboard shortcut to toggle (e.g., Ctrl+Shift+R)

### 3.2 Audio Beeps for All Modes (REQ-303)

**Problem:** The 3-tone beep feedback (recording start, recording stop, transcription complete) currently only works via REST API connection events. Push-to-talk, VAD, and toggle modes lack audio feedback.

**Solution:** Move beep playback to the frontend (Web Audio API or `<audio>` elements) triggered by state changes:
- **Beep 1** (ascending tone): Recording started
- **Beep 2** (descending tone): Recording stopped, processing
- **Beep 3** (double beep): Transcription complete

**Applies to all activation modes:** push-to-talk, voice activation, toggle, and wake word.

### 3.3 Chat Tab (REQ-304, REQ-305, REQ-306)

**Problem:** The text refinement engine is powerful but only accessible through the STT pipeline. Users want to interact with it like a chatbot - type questions, paste text, or speak - and get refined/processed responses.

**Solution:** A new tab in the main content area that provides a familiar chat interface:

**UI Layout:**
```
+------------------------------------------+
| [STT Tab] [Chat Tab] [Dictation Tab]    |
+------------------------------------------+
|                                          |
|  [AI message bubble]                     |
|        [User message bubble]             |
|  [AI message bubble]                     |
|        [User message bubble]             |
|  [AI message bubble]                     |
|                                          |
+------------------------------------------+
| [Mic icon] [Type your message...] [Send] |
+------------------------------------------+
```

**Features:**
- Messages display in chat bubble format (user right, AI left)
- Microphone icon: click to speak, transcribes via Whisper, sends as message
- Text input: type or paste, press Enter/Send to submit
- Uses the currently selected provider/model/template from refinement config
- Conversation history maintained in-session (and persisted per REQ-318)
- "New Chat" button clears conversation, saves to history

**Backend:** Uses existing `/discuss/chat` endpoint with conversation history support (already implemented).

### 3.4 Dictation Mode (REQ-307, REQ-308, REQ-309, REQ-310)

**Problem:** Current STT is single-shot: speak once, get one transcription. For long-form content (emails, documents, meeting notes), users want to think-pause-continue without losing context.

**Solution:** A "Dictation" tab/mode with canvas-based accumulation:

**Behavior:**
1. User activates dictation mode
2. Microphone stays active, listening continuously
3. When user speaks: transcribes in real-time, appends to canvas
4. When user pauses (silence > threshold): pauses recording, but keeps canvas open
5. When user speaks again: resumes recording, continues appending to same canvas
6. Previous segments are processed/refined in parallel while user continues speaking
7. "New Chat" button: saves current canvas to history, opens fresh canvas

**Canvas Display:**
```
+------------------------------------------+
| DICTATION CANVAS                    [New] |
+------------------------------------------+
| [Refined segment 1 text...]              |
| [Refined segment 2 text...]              |
| [Currently transcribing... |||]          |
|                                          |
+------------------------------------------+
| [Pause] [Stop] [Copy All] [Download]    |
+------------------------------------------+
```

**Key Design Decisions:**
- Silence threshold configurable (default 3s pause = segment break, 10s = auto-pause)
- Each segment independently refined through the AI pipeline
- Canvas accumulates all segments in order
- "New Chat" saves full canvas as one history entry with all segments

### 3.5 MCP Server for Text Refinement (REQ-311, REQ-312)

**Problem:** The text refinement engine is only accessible via the web UI. Other tools (Claude Code, scripts, automation) cannot use it.

**Solution:** An MCP server that exposes the text refinement pipeline:

**Tools:**
```
refine_text(text, provider?, model?, template?)
  - text: required - raw text to refine
  - provider: optional - override current provider (default: use config)
  - model: optional - override current model (default: use config)
  - template: optional - override current template (default: use config)
  - Returns: { refined_text, provider, model, processing_time_ms }

get_refiner_config()
  - Returns current provider, model, template, available providers

set_refiner_config(provider?, model?, template?)
  - Updates the active configuration
```

**Implementation:** Python MCP server using the existing refiner module. Reads from the same config files (.env for keys, refiner.json for settings).

### 3.6 Wake Word Trigger (REQ-313, REQ-314)

**Problem:** All current activation modes require physical interaction (click, keypress, or continuous listening with VAD). A wake word enables truly hands-free operation.

**Solution:** Browser-based keyword spotting:

**Approach Options (to be decided in ADD):**
- **Option A:** Porcupine (Picovoice) - dedicated wake word engine, very lightweight
- **Option B:** Small Whisper model running continuously, pattern matching on output
- **Option C:** Web Speech API for keyword detection, hand off to Whisper for full STT

**Default wake word:** "Hey Colin" (configurable in settings)

**Behavior:**
1. Wake word listener runs continuously (low CPU)
2. On detection: plays activation beep, starts full STT recording
3. Silence detection stops recording as normal
4. Returns to wake word listening

### 3.7 Mini-Button Collapse (REQ-315, REQ-316)

**Problem:** The full app window takes too much screen space when not actively being used. Users want a minimal floating widget.

**Solution:**
- Collapse button minimizes the UI to a small floating widget (e.g., 48x48px mic icon)
- Browser window resizes to match (uses `window.resizeTo()` if supported, or CSS-only approach)
- Header bar, sidebar, and controls hidden
- Widget shows: mic status (idle/recording/processing), click to expand
- Hover shows last transcription snippet

### 3.8 Persistent History with Projects (REQ-317, REQ-318, REQ-319, REQ-320)

**Problem:** History is lost on page refresh. No way to organize transcriptions by context/project.

**Solution:**

**Storage:** IndexedDB (browser-native, no backend dependency, supports large datasets)
- Fallback: localStorage for small histories, backend SQLite for cross-device sync

**Data Model:**
```typescript
interface HistoryEntry {
  id: string;
  projectId: string | null;
  text: string;           // raw transcription
  refinedText?: string;   // AI-refined version
  provider?: string;
  model?: string;
  template?: string;
  confidence: number;
  timestamp: Date;
  source: 'stt' | 'chat' | 'dictation';
  segments?: string[];    // for dictation mode
}

interface Project {
  id: string;
  name: string;
  color: string;
  createdAt: Date;
}
```

**UI:**
- Left sidebar shows history grouped by project (or "Ungrouped")
- "New Project" button at top of sidebar
- Drag-and-drop entries between projects
- Project filter/selector at top
- Scroll overflow with virtual scrolling for performance
- Search/filter within history

---

## 4. Implementation Phases

### Phase A: Quick Controls & Audio (REQ-301, REQ-302, REQ-303)
- Right sidebar panel with refinement + output tabs
- Frontend beep sounds for all activation modes
- **Estimated complexity:** Medium
- **Dependencies:** None

### Phase B: Chat Tab (REQ-304, REQ-305, REQ-306)
- Chat interface tab with voice + text input
- Uses existing discuss/refine backend
- **Estimated complexity:** Medium
- **Dependencies:** Phase A (uses right sidebar controls)

### Phase C: Dictation Mode (REQ-307, REQ-308, REQ-309, REQ-310)
- Continuous recording with pause/resume
- Canvas accumulation with parallel refinement
- Session management (new chat, save to history)
- **Estimated complexity:** High
- **Dependencies:** Phase B (shares chat infrastructure)

### Phase D: History Persistence & Projects (REQ-317, REQ-318, REQ-319, REQ-320)
- IndexedDB storage layer
- Project CRUD operations
- History grouping and filtering UI
- Migration of in-memory history to persistent storage
- **Estimated complexity:** Medium-High
- **Dependencies:** Phase C (dictation entries need persistence)

### Phase E: MCP Server (REQ-311, REQ-312)
- Python MCP server wrapping refiner module
- Config sharing with web backend
- **Estimated complexity:** Medium
- **Dependencies:** None (can run in parallel with any phase)

### Phase F: Wake Word & Mini-Button (REQ-313, REQ-314, REQ-315, REQ-316)
- Wake word detection (technology selection in ADD)
- Mini-button collapse UI
- Browser resize behavior
- **Estimated complexity:** High (wake word), Low (mini-button)
- **Dependencies:** Phase A (mini-button integrates with layout)

---

## 5. Technical Considerations

### 5.1 Right Sidebar Architecture
- Must coexist with left history sidebar and center content
- Consider z-index layering (overlay vs push)
- Mobile breakpoint: collapse both sidebars, use bottom sheet

### 5.2 Audio Beeps
- Use Web Audio API for generated tones (no file downloads)
- Respect browser autoplay policies (require user interaction first)
- Volume control tied to existing settings

### 5.3 Dictation Parallel Processing
- WebSocket streaming for real-time partial transcripts (future enhancement)
- For v1.3: segment-based processing (complete segment -> send to refiner -> display)
- Use Web Workers for audio processing to keep UI responsive

### 5.4 MCP Server
- Standalone process, communicates with refiner via REST API or shared config
- Option A: Thin MCP wrapper calling existing FastAPI endpoints
- Option B: Direct refiner module import (shares Python process)
- Must handle concurrent requests

### 5.5 Wake Word
- CPU budget: < 5% when idle listening
- Must work in browser (no native dependencies)
- Privacy: all processing local (no cloud wake word detection)

---

## 6. Acceptance Criteria

| ID | Criterion | Test Method |
|----|-----------|-------------|
| AC-301 | Right sidebar opens/closes with one click | Manual UI test |
| AC-302 | Provider/model/template change takes effect immediately | E2E test |
| AC-303 | Beeps play for all 4 activation modes | Manual audio test |
| AC-304 | Chat tab accepts voice, text, and paste input | E2E test |
| AC-305 | Dictation accumulates across pauses in one canvas | Manual test |
| AC-306 | "New Chat" saves canvas to history and clears | Manual test |
| AC-307 | History survives browser refresh | Automated test |
| AC-308 | Projects can be created, renamed, deleted | Automated test |
| AC-309 | MCP refine_text returns refined text with defaults | Integration test |
| AC-310 | MCP accepts provider/model/template overrides | Integration test |
| AC-311 | Wake word "Hey Colin" triggers recording | Manual test |
| AC-312 | Mini-button shows mic status and expands on click | Manual test |
| AC-313 | History scrolls properly with 100+ entries | Performance test |

---

## 7. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Wake word accuracy in noisy environments | False triggers or missed activations | Configurable sensitivity, visual confirmation before STT |
| IndexedDB storage limits | History loss for heavy users | Implement export/backup, monitor storage usage |
| Dictation mode CPU usage | Browser lag during long sessions | Web Workers for audio, batch processing |
| MCP server port conflicts | Can't start alongside web backend | Configurable port, auto-detect available |
| Browser resize API limitations | window.resizeTo() blocked in some contexts | CSS-only fallback with fixed position |

---

*PRD-003 created 2026-02-19. Pending review and approval by Colin Bacon.*
