# PRD-004: BACON-AI Voice v1.4 - File Transcription & Suffix Injections

| Field | Value |
|-------|-------|
| **Document ID** | PRD-004 |
| **Version** | 1.4 |
| **Status** | Draft |
| **Date** | 2026-02-23 |
| **Author** | Orchestrator Agent (Opus 4.6) |
| **Project** | bacon-ai-voice |
| **Depends On** | PRD-001 (v1.0), PRD-002 (v1.1), PRD-003 (v1.3) |

---

## 1. Problem Statement

### 1.1 Current State

BACON-AI Voice v1.2 delivers real-time speech-to-text with AI text refinement through 6 provider backends. However, users frequently have pre-recorded audio files (meetings, interviews, voice memos, podcasts) that they want transcribed without re-playing them through a microphone. Currently, transcribing a file requires using Whisper CLI directly or a separate tool, losing the benefit of the integrated refiner pipeline.

Additionally, users often need to append consistent instructions or context to their transcriptions before they reach the refiner or keyboard output. For example, appending "Format as bullet points" or "This is a code review comment" to every transcription. Currently, this requires manual editing after each transcription.

### 1.2 Desired State

1. **File Transcription Panel**: Users can upload audio/video files or provide a local file path, and the system transcribes them using the already-loaded Whisper model. Output is available as .txt, .srt, or .vtt with an optional refiner pass.
2. **Suffix Injection Prompts**: Users can configure text snippets that are automatically appended to transcriptions before they reach the refiner or keyboard output. Built-in and custom injections are toggled via checkboxes.

### 1.3 Success Criteria

- SC-401: Audio files up to 2 hours can be transcribed without timeout
- SC-402: Transcription reuses the already-loaded Whisper model (no duplicate loading)
- SC-403: Output files (.txt, .srt, .vtt) are downloadable from the UI
- SC-404: Refiner pipeline processes file transcriptions identically to live transcriptions
- SC-405: Suffix injections apply consistently across live, file, and keyboard workflows
- SC-406: Injection configuration persists across page reloads (localStorage)

---

## 2. Scope

### 2.1 In Scope

#### FEAT-310: File Transcription Panel

| ID | Requirement | Priority |
|----|------------|----------|
| REQ-401 | File upload (drag-drop or browse) OR local path text input | P0 (Must) |
| REQ-402 | Transcribe with faster-whisper, reuse loaded model | P0 (Must) |
| REQ-403 | Output formats: .txt (default), .srt, .vtt | P1 (Should) |
| REQ-404 | Download link for output file shown after transcription | P0 (Must) |
| REQ-405 | "Pipe through refiner" checkbox (uses current refiner settings) | P0 (Must) |
| REQ-406 | Progress indicator during transcription | P1 (Should) |
| REQ-407 | Language selector (default: auto-detect) | P1 (Should) |
| REQ-408 | Model selector (reuses existing loaded model by default) | P1 (Should) |

#### FEAT-311: Suffix Injection Prompts

| ID | Requirement | Priority |
|----|------------|----------|
| REQ-409 | Suffix injections appended before refiner/keyboard output | P0 (Must) |
| REQ-410 | 10 built-in injection prompts (enabled/disabled per checkbox) | P0 (Must) |
| REQ-411 | Add / edit / delete custom injection prompts | P1 (Should) |
| REQ-412 | Injections apply in: Live transcription, File transcription, keyboard typing | P0 (Must) |
| REQ-413 | Injections persist in localStorage (same as other settings) | P0 (Must) |

### 2.2 Out of Scope (Deferred to v1.5+)

- YouTube / URL transcription (fetching audio from remote URLs)
- Speaker diarization (who said what)
- Batch file processing (multiple files queued)
- Translation (transcribe in one language, output in another)
- Real-time streaming progress for file transcription (v1.4 uses polling)

---

## 3. User Stories

### US-401: Transcribe an Audio File

**As a** BACON-AI Voice user
**I want to** upload an audio file or provide a local path and get a transcription
**So that** I can transcribe meetings, voice memos, and recordings without replaying them through my microphone

**Acceptance Criteria:**
- Upload via drag-drop or file browser
- Alternatively, paste a local file path
- See progress while transcription runs
- Download the output as .txt, .srt, or .vtt

### US-402: Refine File Transcription

**As a** BACON-AI Voice user
**I want to** optionally pipe file transcriptions through my configured refiner
**So that** file transcriptions get the same AI cleanup as live transcriptions

**Acceptance Criteria:**
- "Pipe through refiner" checkbox available
- Uses current provider, model, and prompt settings
- Refined text shown alongside raw text

### US-403: Append Suffix Injections

**As a** BACON-AI Voice user
**I want to** automatically append instructions to my transcriptions
**So that** my refiner or target application receives consistent context with every transcription

**Acceptance Criteria:**
- Toggle built-in injections on/off via checkboxes
- Create custom injection prompts
- Injections apply to live, file, and keyboard output
- Settings persist across reloads

---

## 4. UI Mockups

### 4.1 File Transcription Panel (new tab in main area)

```
+--------------------------------------------------------------------+
|  [ Live ]  [ File Transcription ]  [ Discuss ]                     |
+--------------------------------------------------------------------+
|                                                                    |
|  +--------------------------------------------------------------+ |
|  |                                                                | |
|  |       Drag & drop audio/video file here                       | |
|  |              or click to browse                                | |
|  |                                                                | |
|  +--------------------------------------------------------------+ |
|                                                                    |
|  OR enter local file path:                                         |
|  +--------------------------------------------------------------+ |
|  | C:\Users\colin\recordings\meeting.mp3                   [Go]  | |
|  +--------------------------------------------------------------+ |
|                                                                    |
|  Language: [ Auto-detect  v]   Format: [ .txt  v]                  |
|  Model:    [ (current: base) v]                                    |
|  [x] Pipe through refiner                                          |
|                                                                    |
|  [ Transcribe ]                                                    |
|                                                                    |
|  Progress: [=========>          ] 45%  (2:15 / 5:00)               |
|                                                                    |
|  +--------------------------------------------------------------+ |
|  | Transcription output text appears here...                      | |
|  |                                                                | |
|  +--------------------------------------------------------------+ |
|  [ Download .txt ]  [ Copy to clipboard ]                          |
|                                                                    |
+--------------------------------------------------------------------+
```

### 4.2 Suffix Injection Settings (QCS right sidebar tab)

```
+----------------------------------+
| Quick Controls                   |
| [ Provider ] [ Output ] [Inject] |
+----------------------------------+
| Suffix Injections                |
|                                  |
| [x] Format as bullet points     |
| [ ] Add paragraph breaks        |
| [x] Remove filler words         |
| [ ] Convert to formal tone      |
| [ ] Add timestamps              |
| [ ] Code review format          |
| [ ] Meeting notes format        |
| [ ] Email draft format          |
| [ ] Technical documentation     |
| [ ] Summarize key points        |
|                                  |
| --- Custom ---                   |
| [x] My custom prompt 1          |
| [ ] Another custom prompt       |
|                                  |
| [ + Add custom injection ]      |
|                                  |
| Apply to:                        |
| [x] Live transcription          |
| [x] File transcription          |
| [x] Keyboard typing             |
+----------------------------------+
```

---

## 5. Technical Constraints

- File size limit: 500 MB (larger files should use CLI directly)
- Supported formats: .mp3, .wav, .webm, .m4a, .ogg, .flac, .mp4, .mkv, .avi
- Output directory: `/tmp/bacon-voice-transcripts/` with 10-minute TTL cleanup
- Whisper model: reuse the currently loaded model to avoid double memory usage
- SRT/VTT: require segment-level timestamps from Whisper

---

## 6. Dependencies

| Dependency | Type | Status |
|-----------|------|--------|
| Faster-Whisper engine | Existing | Available (v1.0+) |
| Refiner pipeline | Existing | Available (v1.1+) |
| 6 refiner providers | Existing | Available (v1.2) |
| React tab navigation | Existing | Available (v1.2 - Live/Discuss tabs) |
| QCS right sidebar | Planned (v1.3) or inline | REQ-301 |

---

## 7. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Large files cause OOM with Whisper | Medium | High | Set 500MB limit, warn user |
| SRT timestamp accuracy | Low | Medium | Use Whisper segment timestamps directly |
| Too many injections degrade refiner quality | Medium | Medium | Warn when > 3 injections enabled |
| File upload CORS issues | Low | Low | Already handled by existing CORS config |
